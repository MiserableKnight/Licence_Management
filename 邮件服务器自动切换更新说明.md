# 邮件服务器自动切换功能 - 更新说明

## 更新概述

本次更新实现了邮件服务器自动切换机制，解决了Gmail在国内无法访问导致邮件发送失败的问题。

**主要改进：**
1. ✅ 支持配置主服务器和多个备用服务器
2. ✅ 主服务器失败时自动尝试备用服务器
3. ✅ 改进错误提示，明确说明失败原因和解决建议
4. ✅ 向后兼容旧配置格式
5. ✅ 详细的日志记录，便于问题排查

## 修改的文件

### 1. `licence_management/config/config_manager.py`
**修改内容：**
- 新增 `SmtpServerConfig` 数据类（单个SMTP服务器配置）
- 修改 `EmailConfig` 数据类：
  - 添加 `primary_server: SmtpServerConfig`
  - 添加 `backup_servers: List[SmtpServerConfig]`
  - 添加 `max_retry_attempts: int`
- 修改 `_build_email_config()` 方法：
  - 支持新格式（primary_server + backup_servers）
  - 自动识别并转换旧格式
  - 向后兼容旧配置文件
- 新增 `_build_smtp_server_config()` 辅助方法
- 更新 `validate_config()` 验证逻辑
- 更新 `save_default_config()` 生成新格式模板

### 2. `licence_management/email/email_sender.py`
**修改内容：**
- 修改 `_create_email_message()` 方法，接受服务器配置参数
- 重构 `_send_email()` 方法，实现多服务器自动切换逻辑：
  - 尝试主服务器
  - 失败时依次尝试备用服务器
  - 记录每次尝试的详细日志
- 新增 `_send_email_via_server()` 方法，处理单服务器发送逻辑
- 新增 `_get_auth_error_suggestion()` 方法，提供认证错误建议
- 新增 `_get_connection_error_suggestion()` 方法，提供连接错误建议
- 新增 `_get_network_error_suggestion()` 方法，提供网络错误建议
- 新增 `_log_failure_suggestions()` 方法，记录总结性建议
- 更新 `validate_email_config()` 验证逻辑

### 3. `config.yaml`
**修改内容：**
- 将邮件配置更新为新格式：
  - 添加 `primary_server` 配置块（Gmail）
  - 添加 `backup_servers` 列表（QQ邮箱）
  - 保留 `receiver_email` 和 `max_retry_attempts`

### 4. 新增文件
- `QQ邮箱配置指南.md` - QQ邮箱授权码获取和配置说明
- `test_email_failover.py` - 自动切换功能测试脚本

## 配置格式对比

### 旧格式（自动兼容）
```yaml
email:
  smtp_server: smtp.gmail.com
  smtp_port: 587
  smtp_user: your_email@gmail.com
  smtp_password: your_password
  sender_name: 证件管理系统
  receiver_email: recipient@example.com
  use_ssl: false
  use_tls: true
```

### 新格式（推荐）
```yaml
email:
  primary_server:
    name: Gmail
    smtp_server: smtp.gmail.com
    smtp_port: 587
    smtp_user: your_email@gmail.com
    smtp_password: your_password
    sender_name: 证件管理系统
    use_ssl: false
    use_tls: true

  backup_servers:
    - name: QQ邮箱
      smtp_server: smtp.qq.com
      smtp_port: 587
      smtp_user: your_email@qq.com
      smtp_password: your_qq_auth_code
      sender_name: 证件管理系统
      use_ssl: false
      use_tls: true

  receiver_email: recipient@example.com
  max_retry_attempts: 3
```

## 使用说明

### 1. 配置QQ邮箱作为备用服务器

请按照 `QQ邮箱配置指南.md` 中的步骤获取QQ邮箱授权码，然后更新 `config.yaml`：

```yaml
email:
  backup_servers:
    - name: QQ邮箱
      smtp_server: smtp.qq.com
      smtp_port: 587
      smtp_user: 970937197@qq.com        # 替换为你的QQ邮箱
      smtp_password: your_qq_auth_code    # 替换为你的授权码
      sender_name: 证件管理系统
      use_ssl: false
      use_tls: true
```

### 2. 验证配置

运行测试命令：

```bash
# Windows (虚拟环境)
.\venv\Scripts\python.exe -m licence_management --test-email

# Linux/Mac
python3 -m licence_management --test-email
```

### 3. 查看日志

日志文件位于：`logs/licence_management_YYYY-MM-DD.log`

日志会记录：
- 每个服务器的尝试过程
- 详细的错误信息
- 针对性的解决建议

**成功日志示例：**
```
INFO - 尝试使用服务器 [Gmail] (1/2)
INFO -   地址: smtp.gmail.com:587
ERROR - 服务器 [Gmail] 连接断开: Connection refused
WARNING -  ✗ 服务器 [Gmail] 发送失败，自动切换到下一个备用服务器...
INFO - 尝试使用服务器 [QQ邮箱] (2/2)
INFO -   地址: smtp.qq.com:587
INFO - 服务器 [QQ邮箱] 认证成功，开始发送邮件
INFO - ✓ 邮件通过服务器 [QQ邮箱] 发送成功
```

### 4. 测试自动切换功能

使用提供的测试脚本：

```bash
python test_email_failover.py
```

这个脚本会模拟主服务器故障，验证自动切换功能。

## 自动切换机制

系统会按照以下顺序尝试发送邮件：

```
1. 尝试主服务器
   ↓ 失败
2. 尝试备用服务器 #1
   ↓ 失败
3. 尝试备用服务器 #2
   ↓ 失败
...
N. 所有服务器都失败，记录详细错误和解决建议
```

### 错误处理和提示

系统会根据不同的错误类型提供针对性的解决建议：

**Gmail连接失败：**
```
ERROR - 无法连接到服务器 [Gmail]: Connection timed out
建议解决方法:
  1. Gmail在国内无法直接访问，建议使用QQ邮箱等国内邮件服务
  2. 如果需要使用Gmail，请配置VPN或代理
  3. 建议在config.yaml中将QQ邮箱配置为primary_server
```

**QQ邮箱认证失败：**
```
ERROR - 服务器 [QQ邮箱] SMTP认证失败: Authentication failed
建议解决方法:
  1. 请确保已开启QQ邮箱SMTP服务
  2. 登录QQ邮箱 -> 设置 -> 账户 -> SMTP服务
  3. 使用授权码（而非登录密码）
```

**网络问题：**
```
ERROR - 服务器 [QQ邮箱] 网络错误: Network unreachable
建议解决方法:
  1. 请检查网络连接是否正常
  2. 检查防火墙设置
  3. 确认SMTP服务器地址和端口配置正确
```

## 向后兼容性

系统会自动识别旧配置格式并转换为新格式，无需手动修改。

**检测到旧格式时的日志：**
```
DeprecationWarning: 邮件配置使用了旧格式，已自动转换为新格式。
建议将配置文件更新为：primary_server + backup_servers 格式。
参考：https://github.com/your-repo/docs/config-upgrade.md
```

建议尽快更新配置文件为新格式，以充分利用自动切换功能。

## 常用邮箱配置参考

### QQ邮箱（推荐用于国内）
```yaml
smtp_server: smtp.qq.com
smtp_port: 587  # TLS 或 465 SSL
smtp_user: your_email@qq.com
smtp_password: your_qq_auth_code  # 授权码，不是登录密码
```

### 163邮箱
```yaml
smtp_server: smtp.163.com
smtp_port: 465  # SSL 或 994 TLS
smtp_user: your_email@163.com
smtp_password: your_auth_code  # 授权码，不是登录密码
```

### Gmail（需要VPN或代理）
```yaml
smtp_server: smtp.gmail.com
smtp_port: 587  # TLS
smtp_user: your_email@gmail.com
smtp_password: your_app_password  # 应用专用密码
```

## 常见问题

### Q1: 为什么要添加备用服务器？
**A:** Gmail在国内无法直接访问，配置QQ邮箱等国内邮件服务作为备用服务器可以确保邮件发送功能正常工作。

### Q2: 只配置一个服务器可以吗？
**A:** 可以。如果只配置主服务器，系统会像以前一样工作，但没有自动切换能力。

### Q3: 如何配置多个备用服务器？
**A:** 在 `config.yaml` 的 `backup_servers` 列表中添加多个服务器配置即可。

### Q4: 如何禁用Gmail，只使用QQ邮箱？
**A:** 将QQ邮箱配置为 `primary_server`，删除或留空 `backup_servers`。

### Q5: 授权码忘记了怎么办？
**A:** 需要重新登录邮箱生成新的授权码。旧的授权码无法找回。

## 测试验证

### 1. 配置验证测试
```bash
python -m licence_management --test-email
```

### 2. 自动切换测试
```bash
python test_email_failover.py
```

### 3. 日志验证
检查 `logs/licence_management_*.log` 文件，确认：
- 记录了服务器切换过程
- 有清晰的错误提示
- 包含解决建议

## 升级建议

1. **立即更新配置文件**：将 `config.yaml` 更新为新格式
2. **配置QQ邮箱**：按照 `QQ邮箱配置指南.md` 获取授权码
3. **测试验证**：运行 `--test-email` 命令验证配置
4. **监控日志**：初期多查看日志，确保自动切换正常工作

## 技术细节

### 错误处理策略
- 连接超时：30秒
- 自动切换：失败后立即尝试下一个服务器
- 连接清理：确保失败后正确关闭连接

### 日志级别
- INFO：服务器切换、发送成功
- WARNING：服务器失败，切换到下一个
- ERROR：所有服务器失败，包含详细错误和建议
- DEBUG：详细的连接和认证过程

### 性能考虑
- 按顺序尝试服务器，不会并发
- 每个服务器超时30秒，避免长时间等待
- 失败后立即切换，最小化延迟

## 后续改进方向

1. ✅ 多服务器自动切换（已完成）
2. ⏳ 服务器健康检查（计划中）
3. ⏳ 发送统计和成功率报告（计划中）
4. ⏳ 智能服务器选择（根据历史成功率）（计划中）

## 技术支持

如有问题，请查看：
- 日志文件：`logs/licence_management_*.log`
- QQ邮箱配置：`QQ邮箱配置指南.md`
- 测试脚本：`test_email_failover.py`

---

**更新日期：** 2025-01-27
**版本：** v2.0 - 邮件服务器自动切换
